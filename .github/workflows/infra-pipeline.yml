name: CI-CD Terraform & Kubernetes

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - nonprod
          - prod
      destroy:
        description: 'Destroy resources?'
        required: true
        default: 'false'
        type: boolean

env:
  TF_DIR: terraform
  AWS_REGION: eu-west-1

jobs:

  terraform-plan:
    if: ${{ github.event.inputs.destroy == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Terraform Init & Plan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          set -euo pipefail
          cd $TF_DIR
          terraform init -input=false
          terraform workspace select ${{ github.event.inputs.env }} || terraform workspace new ${{ github.event.inputs.env }}
          terraform plan -var-file="${{ github.event.inputs.env }}.tfvars" -out=tfplan

      - name: Upload Terraform Plan Artifact
        uses: actions/upload-artifact@v3
        with:
          name: tfplan
          path: $TF_DIR/tfplan

  terraform-apply:
    if: ${{ github.event.inputs.destroy == 'false' }}
    needs: terraform-plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Download Terraform Plan
        uses: actions/download-artifact@v3
        with:
          name: tfplan
          path: $TF_DIR

      - name: Terraform Apply
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          set -euo pipefail
          cd $TF_DIR
          terraform init -input=false
          terraform workspace select ${{ github.event.inputs.env }}
          terraform apply -auto-approve tfplan

  kubernetes-deploy:
    if: ${{ github.event.inputs.destroy == 'false' }}
    needs: terraform-apply
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: latest

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: latest

      - name: Configure kubeconfig
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail
          cd $TF_DIR
          terraform init -input=false
          terraform workspace select ${{ github.event.inputs.env }}
          CLUSTER_NAME=$(terraform output -raw cluster_name)
          aws eks update-kubeconfig --name "$CLUSTER_NAME" --region "$AWS_REGION"
          kubectl get nodes

      - name: Install Ingress Nginx via Helm
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx \
            --create-namespace \
            --set controller.service.type=LoadBalancer \
            --wait --timeout 5m

      - name: Build, Push & Deploy App
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail
          cd $TF_DIR
          terraform init -input=false
          terraform workspace select ${{ github.event.inputs.env }}
          ECR_URL=$(terraform output -raw ecr_repository_url)
          CLUSTER_NAME=$(terraform output -raw cluster_name)
          cd ..
          
          IMAGE_TAG=${GITHUB_RUN_ID}
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

          docker build -t app:$IMAGE_TAG app
          docker tag app:$IMAGE_TAG $ECR_URL:$IMAGE_TAG
          docker push $ECR_URL:$IMAGE_TAG

          aws eks update-kubeconfig --name "$CLUSTER_NAME" --region "$AWS_REGION"

          helm upgrade --install auto-dev-demo helm/auto-dev-demo \
            --namespace demo \
            --create-namespace \
            --set image.repository=$ECR_URL \
            --set image.tag=$IMAGE_TAG \
            --wait

          kubectl get pods -n demo
          kubectl get ingress -n demo

  terraform-destroy:
    if: ${{ github.event.inputs.destroy == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Terraform Destroy
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          set -euo pipefail
          cd $TF_DIR
          terraform init -input=false
          terraform workspace select ${{ github.event.inputs.env }}
          terraform destroy -var-file="${{ github.event.inputs.env }}.tfvars" -auto-approve
