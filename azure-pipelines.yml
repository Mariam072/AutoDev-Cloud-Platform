trigger: none
pr: none

parameters:
  - name: env
    type: string
    default: prod
    values:
      - nonprod
      - prod

  - name: destroy
    type: boolean
    default: false

variables:
  TF_DIR: terraform
  TF_VAR_FILE: '${{ parameters.env }}.tfvars'
  AWS_SERVICE_CONNECTION: mero
  AWS_REGION: eu-west-1

pool:
  vmImage: ubuntu-latest

# =========================
# 1️⃣ Terraform Plan
# =========================
stages:
- stage: Plan
  condition: eq('${{ parameters.destroy }}', false)
  jobs:
  - job: Plan
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform Init & Plan
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd $(TF_DIR)

          terraform init -input=false
          terraform workspace select ${{ parameters.env }} || terraform workspace new ${{ parameters.env }}
          terraform plan -var-file="$(TF_VAR_FILE)" -out=tfplan

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: $(TF_DIR)/tfplan
        artifact: tfplan

# =========================
# 2️⃣ Terraform Apply
# =========================
- stage: Apply
  dependsOn: Plan
  condition: eq('${{ parameters.destroy }}', false)
  jobs:
  - job: Apply
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: latest

    - task: DownloadPipelineArtifact@2
      inputs:
        artifact: tfplan
        path: $(TF_DIR)

    - task: AWSShellScript@1
      displayName: Terraform Apply
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd $(TF_DIR)
          terraform init -input=false
          terraform workspace select ${{ parameters.env }}
          terraform apply -auto-approve tfplan

# =========================
# 3️⃣ Kubernetes + Ingress + Deploy
# =========================
- stage: Kubernetes
  dependsOn: Apply
  condition: eq('${{ parameters.destroy }}', false)
  jobs:
  - job: Deploy
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: latest

    - task: KubectlInstaller@0
      inputs:
        kubectlVersion: latest

    - task: HelmInstaller@1
      inputs:
        helmVersionToInstall: latest

    - task: AWSShellScript@1
      displayName: Configure kubeconfig
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd $(TF_DIR)
          terraform init -input=false
          terraform workspace select ${{ parameters.env }}
          CLUSTER_NAME=$(terraform output -raw cluster_name)
          aws eks update-kubeconfig --name "$CLUSTER_NAME" --region "$(AWS_REGION)"
          kubectl get nodes

    - task: AWSShellScript@1
      displayName: Export AWS Credentials
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          echo "##vso[task.setvariable variable=AWS_ACCESS_KEY_ID;isSecret=true]$AWS_ACCESS_KEY_ID"
          echo "##vso[task.setvariable variable=AWS_SECRET_ACCESS_KEY;isSecret=true]$AWS_SECRET_ACCESS_KEY"
          echo "##vso[task.setvariable variable=AWS_SESSION_TOKEN;isSecret=true]$AWS_SESSION_TOKEN"

    - task: HelmDeploy@0
      displayName: Install Ingress Nginx
      inputs:
        connectionType: None
        command: upgrade
        chartType: Name
        chartName: ingress-nginx
        releaseName: ingress-nginx
        namespace: ingress-nginx
        install: true
        arguments: >
          --repo https://kubernetes.github.io/ingress-nginx
          --create-namespace
          --set controller.ingressClassResource.defaultTLSSecret=""
          --wait
          --timeout 5m
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_SESSION_TOKEN: $(AWS_SESSION_TOKEN)
        AWS_REGION: $(AWS_REGION)

    - task: AWSShellScript@1
      displayName: Build, Push & Deploy App
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd $(TF_DIR)
          terraform init -input=false
          terraform workspace select ${{ parameters.env }}
          ECR_URL=$(terraform output -raw ecr_repository_url)
          CLUSTER_NAME=$(terraform output -raw cluster_name)
          cd ..

          IMAGE_TAG=$(Build.BuildId)
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          aws ecr get-login-password --region $(AWS_REGION) | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$(AWS_REGION).amazonaws.com

          docker build -t app:$IMAGE_TAG app
          docker tag app:$IMAGE_TAG $ECR_URL:$IMAGE_TAG
          docker push $ECR_URL:$IMAGE_TAG

          aws eks update-kubeconfig --name "$CLUSTER_NAME" --region "$(AWS_REGION)"

          helm upgrade --install auto-dev-demo helm/auto-dev-demo \
            --namespace demo \
            --create-namespace \
            --set image.repository=$ECR_URL \
            --set image.tag=$IMAGE_TAG \
            --wait

          kubectl get pods -n demo
          kubectl get ingress -n demo

# =========================
# 4️⃣ Destroy
# =========================
- stage: Destroy
  condition: eq('${{ parameters.destroy }}', true)
  jobs:
  - job: Destroy
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform Destroy
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd $(TF_DIR)
          terraform init -input=false
          terraform workspace select ${{ parameters.env }}
          terraform destroy -var-file="$(TF_VAR_FILE)" -auto-approve
