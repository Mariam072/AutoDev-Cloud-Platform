trigger: none
pr: none

parameters:
  - name: env
    displayName: Environment
    type: string
    default: prod
    values:
      - nonprod
      - prod

  - name: destroy
    displayName: Destroy
    type: boolean
    default: false

variables:
  TF_DIR: terraform
  TF_VAR_FILE: '${{ parameters.env }}.tfvars'
  AWS_SERVICE_CONNECTION: 'AWS-Service-Connection'
  AWS_REGION: eu-west-1

pool:
  vmImage: ubuntu-latest

steps:
- checkout: self

# ───────────────────────── Terraform Install ─────────────────────────
- task: TerraformInstaller@1
  displayName: Install Terraform
  inputs:
    terraformVersion: 1.6.6

# ───────────────────────── AWS Auth ─────────────────────────
- task: AWSShellScript@1
  displayName: Configure AWS credentials
  inputs:
    awsCredentials: $(AWS_SERVICE_CONNECTION)
    regionName: $(AWS_REGION)
    scriptType: inline
    inlineScript: |
      set -euo pipefail
      echo "AWS credentials configured"

# ───────────────────────── Terraform Init ─────────────────────────
- task: AWSShellScript@1
  displayName: Terraform init
  inputs:
    awsCredentials: $(AWS_SERVICE_CONNECTION)
    regionName: $(AWS_REGION)
    scriptType: inline
    inlineScript: |
      set -euo pipefail
      cd "$(TF_DIR)"
      terraform init -reconfigure

# ───────────────────────── Workspace Selection ─────────────────────────
- task: AWSShellScript@1
  displayName: Select Terraform workspace
  inputs:
    awsCredentials: $(AWS_SERVICE_CONNECTION)
    regionName: $(AWS_REGION)
    scriptType: inline
    inlineScript: |
      set -euo pipefail
      cd "$(TF_DIR)"

      if [ "${{ parameters.env }}" = "prod" ]; then
        echo "Using default workspace for prod"
        terraform workspace select default
      else
        echo "Using nonprod workspace"
        terraform workspace select nonprod || terraform workspace new nonprod
      fi

# ───────────────────────── Terraform Plan ─────────────────────────
- task: AWSShellScript@1
  displayName: Terraform plan
  condition: eq('${{ parameters.destroy }}', false)
  inputs:
    awsCredentials: $(AWS_SERVICE_CONNECTION)
    regionName: $(AWS_REGION)
    scriptType: inline
    inlineScript: |
      set -euo pipefail
      cd "$(TF_DIR)"
      terraform plan -out=tfplan -var-file="$(TF_VAR_FILE)"

# ───────────────────────── Terraform Apply (WITH APPROVAL) ─────────────────────────
- job: TerraformApply
  displayName: Terraform Apply
  condition: eq('${{ parameters.destroy }}', false)
  environment: ${{ parameters.env }}
  pool:
    vmImage: ubuntu-latest
  steps:
    - task: AWSShellScript@1
      displayName: Terraform apply
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd "$(TF_DIR)"
          terraform apply -auto-approve tfplan

# ───────────────────────── Destroy Plan ─────────────────────────
- task: AWSShellScript@1
  displayName: Terraform plan destroy
  condition: eq('${{ parameters.destroy }}', true)
  inputs:
    awsCredentials: $(AWS_SERVICE_CONNECTION)
    regionName: $(AWS_REGION)
    scriptType: inline
    inlineScript: |
      set -euo pipefail
      cd "$(TF_DIR)"
      terraform plan -destroy -out=tfplan -var-file="$(TF_VAR_FILE)"

# ───────────────────────── Destroy Apply (WITH APPROVAL) ─────────────────────────
- job: TerraformDestroy
  displayName: Terraform Destroy
  condition: eq('${{ parameters.destroy }}', true)
  environment: ${{ parameters.env }}
  pool:
    vmImage: ubuntu-latest
  steps:
    - task: AWSShellScript@1
      displayName: Terraform apply destroy
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd "$(TF_DIR)"
          terraform apply -auto-approve tfplan
