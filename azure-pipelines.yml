trigger: none
pr: none

parameters:
  - name: env
    displayName: Environment
    type: string
    default: prod
    values:
      - nonprod
      - prod

  - name: destroy
    displayName: Destroy Infrastructure
    type: boolean
    default: false

variables:
  TF_DIR: terraform
  TF_VAR_FILE: '${{ parameters.env }}.tfvars'
  AWS_SERVICE_CONNECTION: mero
  AWS_REGION: eu-west-1

pool:
  vmImage: ubuntu-latest

stages:

# ======================
# Terraform Plan Stage
# ======================
- stage: Plan
  displayName: Terraform Plan
  jobs:
  - job: Plan
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform Init & Workspace
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd $(TF_DIR)
          terraform init
          terraform workspace select ${{ parameters.env }} || \
          terraform workspace new ${{ parameters.env }}

    - task: AWSShellScript@1
      displayName: Terraform Validate
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          cd $(TF_DIR)
          terraform validate

    - task: AWSShellScript@1
      displayName: Terraform Plan
      condition: eq('${{ parameters.destroy }}', false)
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          cd $(TF_DIR)
          terraform plan \
            -var-file="$(TF_VAR_FILE)" \
            -out=tfplan

    - task: PublishPipelineArtifact@1
      displayName: Publish Terraform Plan
      condition: eq('${{ parameters.destroy }}', false)
      inputs:
        targetPath: $(TF_DIR)/tfplan
        artifact: tfplan

# ======================
# Manual Approval Stage
# ======================
- stage: Approval
  displayName: Manual Approval
  dependsOn: Plan
  condition: eq('${{ parameters.destroy }}', false)
  jobs:
  - job: Approval
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: |
          Please approve to apply Terraform changes
          Environment: ${{ parameters.env }}
        timeoutInMinutes: 1440
        onTimeout: reject

# ======================
# Terraform Apply Stage
# ======================
- stage: ApplyInfra
  displayName: Terraform Apply
  dependsOn: Approval
  condition: eq('${{ parameters.destroy }}', false)
  jobs:
  - job: Apply
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: DownloadPipelineArtifact@2
      displayName: Download Terraform Plan
      inputs:
        artifact: tfplan
        path: $(TF_DIR)

    - task: AWSShellScript@1
      displayName: Terraform Apply
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          cd $(TF_DIR)
          terraform init
          terraform workspace select ${{ parameters.env }}
          terraform apply -auto-approve tfplan

# ======================
# Helm Tools Stage (kubectl + Helm + ingress-nginx)
# ======================
- stage: HelmTools
  displayName: Install Helm & Ingress
  dependsOn: ApplyInfra
  jobs:
  - job: HelmInstall
    steps:
    - checkout: self

    # 1️⃣ Install kubectl
    - task: Bash@3
      displayName: Install kubectl
      inputs:
        targetType: 'inline'
        script: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

    # 2️⃣ Update kubeconfig
    - task: Bash@3
      displayName: Configure kubeconfig
      inputs:
        targetType: 'inline'
        script: |
          aws eks --region $(AWS_REGION) update-kubeconfig --name $(terraform output -raw cluster_name) --profile $(AWS_SERVICE_CONNECTION)
          kubectl get nodes

    # 3️⃣ Install Helm
    - task: Bash@3
      displayName: Install Helm
      inputs:
        targetType: 'inline'
        script: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

    # 4️⃣ Add repo and install ingress-nginx
    - task: Bash@3
      displayName: Install Ingress NGINX
      inputs:
        targetType: 'inline'
        script: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx --namespace ingress-nginx --create-namespace
          kubectl get pods -n ingress-nginx


# ======================
# Destroy Stage
# ======================
- stage: Destroy
  displayName: Terraform Destroy
  condition: eq('${{ parameters.destroy }}', true)
  jobs:
  - job: Destroy
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform Destroy
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          cd $(TF_DIR)

          terraform init

          terraform workspace select ${{ parameters.env }}

          terraform destroy \
            -var-file="$(TF_VAR_FILE)" \
            -auto-approve
