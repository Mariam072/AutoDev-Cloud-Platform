trigger: none
pr: none

parameters:
  - name: env
    displayName: Environment
    type: string
    default: prod
    values:
      - nonprod
      - prod

  - name: destroy
    displayName: Destroy
    type: boolean
    default: false

variables:
  TF_DIR: terraform
  TF_VAR_FILE: '${{ parameters.env }}.tfvars'
  AWS_SERVICE_CONNECTION: 'AWS-Service-Connection'
  AWS_REGION: eu-west-1

jobs:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PLAN JOB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- job: TerraformPlan
  displayName: Terraform Plan
  pool:
    vmImage: ubuntu-latest
  steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: 1.6.6

    - task: AWSShellScript@1
      displayName: Configure AWS credentials
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          echo "AWS credentials configured"

    - task: AWSShellScript@1
      displayName: Terraform init
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd "$(TF_DIR)"
          terraform init -reconfigure

    - task: AWSShellScript@1
      displayName: Select Terraform workspace
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd "$(TF_DIR)"

          if [ "${{ parameters.env }}" = "prod" ]; then
            terraform workspace select default
          else
            terraform workspace select nonprod || terraform workspace new nonprod
          fi

    - task: AWSShellScript@1
      displayName: Terraform plan
      condition: eq('${{ parameters.destroy }}', false)
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd "$(TF_DIR)"
          terraform plan -out=tfplan -var-file="$(TF_VAR_FILE)"

    - task: AWSShellScript@1
      displayName: Terraform plan destroy
      condition: eq('${{ parameters.destroy }}', true)
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd "$(TF_DIR)"
          terraform plan -destroy -out=tfplan -var-file="$(TF_VAR_FILE)"

    # ðŸ”‘ Share the plan file with next jobs
    - task: PublishPipelineArtifact@1
      displayName: Publish Terraform plan
      inputs:
        targetPath: '$(TF_DIR)/tfplan'
        artifact: tfplan

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ APPLY (DEPLOYMENT JOB + APPROVAL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- deployment: TerraformApply
  displayName: Terraform Apply
  dependsOn: TerraformPlan
  condition: eq('${{ parameters.destroy }}', false)
  environment: ${{ parameters.env }}
  pool:
    vmImage: ubuntu-latest
  strategy:
    runOnce:
      deploy:
        steps:
          - task: DownloadPipelineArtifact@2
            displayName: Download Terraform plan
            inputs:
              artifact: tfplan
              path: $(TF_DIR)

          - task: AWSShellScript@1
            displayName: Terraform apply
            inputs:
              awsCredentials: $(AWS_SERVICE_CONNECTION)
              regionName: $(AWS_REGION)
              scriptType: inline
              inlineScript: |
                set -euo pipefail
                cd "$(TF_DIR)"
                terraform apply -auto-approve tfplan

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DESTROY (DEPLOYMENT JOB + APPROVAL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- deployment: TerraformDestroy
  displayName: Terraform Destroy
  dependsOn: TerraformPlan
  condition: eq('${{ parameters.destroy }}', true)
  environment: ${{ parameters.env }}
  pool:
    vmImage: ubuntu-latest
  strategy:
    runOnce:
      deploy:
        steps:
          - task: DownloadPipelineArtifact@2
            displayName: Download Terraform plan
            inputs:
              artifact: tfplan
              path: $(TF_DIR)

          - task: AWSShellScript@1
            displayName: Terraform apply destroy
            inputs:
              awsCredentials: $(AWS_SERVICE_CONNECTION)
              regionName: $(AWS_REGION)
              scriptType: inline
              inlineScript: |
                set -euo pipefail
                cd "$(TF_DIR)"
                terraform apply -auto-approve tfplan
