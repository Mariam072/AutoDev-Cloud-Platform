trigger: none
pr: none

parameters:
  - name: env
    displayName: Environment
    type: string
    default: prod
    values:
      - nonprod
      - prod

  - name: destroy
    displayName: Destroy Infrastructure
    type: boolean
    default: false

variables:
  TF_DIR: terraform
  TF_VAR_FILE: '${{ parameters.env }}.tfvars'
  AWS_SERVICE_CONNECTION: mero
  AWS_REGION: eu-west-1
  CLUSTER_NAME: "prod-eks-cluster"

pool:
  vmImage: ubuntu-latest

stages:

# ======================
# Terraform Plan Stage
# ======================
- stage: Plan
  displayName: Terraform Plan
  jobs:
  - job: Plan
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform Init & Workspace
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd $(TF_DIR)
          terraform init
          terraform workspace select ${{ parameters.env }} || terraform workspace new ${{ parameters.env }}

    - task: AWSShellScript@1
      displayName: Terraform Validate
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          cd $(TF_DIR)
          terraform validate

    - task: AWSShellScript@1
      displayName: Terraform Plan
      condition: eq('${{ parameters.destroy }}', false)
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          cd $(TF_DIR)
          terraform plan -var-file="$(TF_VAR_FILE)" -out=tfplan

    - task: PublishPipelineArtifact@1
      displayName: Publish Terraform Plan
      condition: eq('${{ parameters.destroy }}', false)
      inputs:
        targetPath: $(TF_DIR)/tfplan
        artifact: tfplan

# ======================
# Manual Approval Stage
# ======================
- stage: Approval
  displayName: Manual Approval
  dependsOn: Plan
  condition: eq('${{ parameters.destroy }}', false)
  jobs:
  - job: Approval
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: |
          Please approve to apply Terraform changes
          Environment: ${{ parameters.env }}
        timeoutInMinutes: 1440
        onTimeout: reject

# ======================
# Terraform Apply Stage
# ======================
- stage: Apply
  displayName: Terraform Apply
  dependsOn: Approval
  condition: eq('${{ parameters.destroy }}', false)
  jobs:
  - job: Apply
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: DownloadPipelineArtifact@2
      displayName: Download Terraform Plan
      inputs:
        artifact: tfplan
        path: $(TF_DIR)

    - task: AWSShellScript@1
      displayName: Terraform Apply
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          cd $(TF_DIR)
          terraform init
          terraform workspace select ${{ parameters.env }}
          terraform apply -auto-approve tfplan

# ======================
# Kubernetes Setup Stage
# ======================
- stage: Kubernetes
  displayName: Kubernetes Setup (kubectl + helm + ingress)
  dependsOn: Apply
  jobs:
  - job: Setup
    steps:
    - checkout: self

    # Install kubectl & helm
    - task: AWSShellScript@1
      displayName: Install kubectl & helm
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail

          # install kubectl
          if ! command -v kubectl &> /dev/null; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi

          # install helm
          if ! command -v helm &> /dev/null; then
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          fi

          # configure kubeconfig
          aws eks --region $(AWS_REGION) update-kubeconfig --name $(CLUSTER_NAME) --profile $(AWS_SERVICE_CONNECTION)

          # add ingress-nginx repo
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update

          # install ingress-nginx
          kubectl create namespace ingress-nginx || true
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx -n ingress-nginx

# ======================
# Destroy Stage
# ======================
- stage: Destroy
  displayName: Terraform Destroy
  condition: eq('${{ parameters.destroy }}', true)
  jobs:
  - job: Destroy
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform Destroy
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          cd $(TF_DIR)
          terraform init
          terraform workspace select ${{ parameters.env }}
          terraform destroy -var-file="$(TF_VAR_FILE)" -auto-approve
